name: Coverity Scan

# We only want to test official release code, not every pull request.
on:
  workflow_dispatch:
  push:
    branches: [develop]

jobs:
  coverity:
    runs-on: ubuntu-latest
    steps:
    - name: Project Setup
      uses: actions/checkout@v3
      run: |
        wget -O- https://apt.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB | gpg --dearmor | sudo tee /usr/share/keyrings/oneapi-archive-keyring.gpg > /dev/null
        echo "deb [signed-by=/usr/share/keyrings/oneapi-archive-keyring.gpg] https://apt.repos.intel.com/oneapi all main" | sudo tee /etc/apt/sources.list.d/oneAPI.list
        sudo apt update
        sudo apt install ninja-build intel-basekit-2024.1
        . /opt/intel/oneapi/setvars.sh
        mkdir build && cd build
        cmake -G"Ninja" ..
    - name: Coverity Scan
      uses: vapier/coverity-scan-action@v1
      with:
        email: 'viraj.malia@intel.com'
        token: ${{ secrets.COVERITY_SCAN_TOKEN }}
        working-directory: 'build'
        description: 'Coverity Scan Description'
        command: ' && ninja'
